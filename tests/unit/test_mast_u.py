import unittest
from pathlib import Path

import numpy as np

from fire.plugins.machine_plugins.mast_u import get_wall_rz_coords

pwd = Path(__file__).parent

try:
    import pyuda
    from mast import mast_client  # Needed for client.get_images() ?
except ImportError as e:
    print(f'Failed to import pyuda for tests')
    pyuda = False

class TestMastU(unittest.TestCase):

    def setUp(self):
        self.r_wall = np.array([1.5644158 , 1.7315794 , 1.3484753 , 1.0881892 , 0.903226  ,
       0.9046392 , 0.5341571 , 0.5382938 , 0.33279714, 0.33279714,
       0.33479592, 0.30311525, 0.30511403, 0.26913595, 0.27113473,
       0.260841  , 0.260841  , 0.27113473, 0.26913595, 0.30511403,
       0.30311525, 0.33479592, 0.33279714, 0.33279714, 0.5382938 ,
       0.5341571 , 0.9046392 , 0.903226  , 1.0881892 , 1.3484753 ,
       1.7315794 , 1.5644158 , 1.3799913 , 1.3798919 , 1.1962221 ,
       1.1963165 , 1.0553741 , 1.0552835 , 0.9475025 , 0.9056864 ,
       0.899143  , 0.88338786, 0.8676812 , 0.85132235, 0.8334819 ,
       0.82606256, 0.8226777 , 0.82102275, 0.82069135, 0.82288736,
       0.827573  , 0.8391946 , 0.8552443 , 0.8775665 , 0.8994735 ,
       1.1856773 , 1.279     , 1.296     , 1.433     , 1.433     ,
       1.49      , 1.46      , 1.46      , 1.661     , 1.661     ,
       1.46      , 1.46      , 1.493     , 1.474     , 1.433     ,
       1.433     , 1.296     , 1.279     , 1.1856773 , 0.8994735 ,
       0.8775665 , 0.8552443 , 0.8391946 , 0.827573  , 0.82288736,
       0.82069135, 0.82102275, 0.8226777 , 0.82606256, 0.8334819 ,
       0.85132235, 0.8676812 , 0.88338786, 0.899143  , 0.9056864 ,
       0.9475025 , 1.0552835 , 1.0553741 , 1.1963165 , 1.1962221 ,
       1.3798919 , 1.3799913 , 1.5644158 ])
        self.z_wall = np.array([ 1.5665352,  1.6800001,  2.0628   ,  2.0628   ,  1.8805648,
        1.8791507,  1.508443 ,  1.5043229,  1.3030896,  1.1      ,
        1.1      ,  0.8535   ,  0.8535   ,  0.571    ,  0.571    ,
        0.5012577, -0.5012577, -0.571    , -0.571    , -0.8535   ,
       -0.8535   , -1.1      , -1.1      , -1.3030896, -1.5043229,
       -1.508443 , -1.8791507, -1.8805648, -2.0628   , -2.0628   ,
       -1.6800001, -1.5665352, -1.5745829, -1.574427 , -1.5824499,
       -1.582598 , -1.5887483, -1.5886062, -1.5933142, -1.5932623,
       -1.5924847, -1.5879643, -1.5785736, -1.5653688, -1.5439421,
       -1.5264524, -1.5128683, -1.4939406, -1.4749435, -1.4435203,
       -1.4169304, -1.3849809, -1.3505412, -1.3197986, -1.2978783,
       -1.0115   , -0.84     , -0.8179   , -0.8179   , -0.711    ,
       -0.491    , -0.491    , -0.233    , -0.233    ,  0.226    ,
        0.226    ,  0.481    ,  0.481    ,  0.554    ,  0.711    ,
        0.8179   ,  0.8179   ,  0.84     ,  1.0115   ,  1.2978783,
        1.3197986,  1.3505412,  1.3849809,  1.4169304,  1.4435203,
        1.4749435,  1.4939406,  1.5128683,  1.5264524,  1.5439421,
        1.5653688,  1.5785736,  1.5879643,  1.5924847,  1.5932623,
        1.5933142,  1.5886062,  1.5887483,  1.582598 ,  1.5824499,
        1.574427 ,  1.5745829,  1.5665352])

    def test_get_uda_mastu_wall_coords(self):
        r, z = get_wall_rz_coords()
        self.assertTrue(np.all(np.isclose(r, self.r_wall)))
        self.assertTrue(np.all(np.isclose(z, self.z_wall)))

def suite():
    suite = unittest.TestSuite()
    loader = unittest.TestLoader()
    # suite.addTests(loader.loadTestsFromTestCase(TestIoIpx))

    if pyuda:
        suite.addTest(TestMastU.test_get_uda_mastu_wall_coords)
    return suite

if __name__ == '__main__':

    runner = unittest.TextTestRunner(failfast=True)
    # unittest.main()
    runner.run(suite())